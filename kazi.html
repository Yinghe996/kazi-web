<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文明演进模拟器 - 联机版</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }

        :root {
            --primary: #2c5530;
            --secondary: #4a7c59;
            --accent: #d4af37;
            --light: #f8f9fa;
            --dark: #1a1d24;
            --danger: #c53030;
            --success: #38a169;
            --warning: #d69e2e;
            --info: #3182ce;
            --river: #4299e1;
            --rock: #718096;
            --village: #e53e3e;
            --ghost: #805ad5;
            --sanctuary: #f6e05e;
            --forest: #38a169;
            --large-village: #c53030;
        }

        body {
            background: linear-gradient(135deg, #1a2a6c, #2c3e50);
            color: var(--light);
            min-height: 100vh;
            padding-bottom: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        header {
            background-color: rgba(44, 62, 80, 0.95);
            padding: 1rem 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--accent);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .game-title {
            font-size: 2.5rem;
            text-align: center;
            margin: 2rem 0;
            color: var(--accent);
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
        }

        .section {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 2rem;
            margin: 2rem 0;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
        }

        .section-title {
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            color: var(--accent);
            border-bottom: 2px solid var(--accent);
            padding-bottom: 0.5rem;
        }

        .btn {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn:hover {
            background-color: var(--secondary);
            transform: translateY(-2px);
        }

        .btn-accent {
            background-color: var(--accent);
            color: var(--dark);
        }

        .btn-accent:hover {
            background-color: #e6c260;
        }

        .btn-danger {
            background-color: var(--danger);
        }

        .btn-danger:hover {
            background-color: #e53e3e;
        }

        .btn-large {
            padding: 1.2rem 2.5rem;
            font-size: 1.2rem;
        }

        /* 主页样式 */
        .hero {
            position: relative;
            height: 500px;
            overflow: hidden;
            border-radius: 12px;
            margin-bottom: 2rem;
        }

        .slideshow {
            height: 100%;
            position: relative;
        }

        .slide {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            transition: opacity 1s ease;
            background-size: cover;
            background-position: center;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .slide.active {
            opacity: 1;
        }

        .slide-content {
            text-align: center;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 2rem;
            border-radius: 8px;
            max-width: 80%;
        }

        .slide-title {
            font-size: 2rem;
            margin-bottom: 1rem;
            color: var(--accent);
        }

        .game-intro {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .intro-card {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 1.5rem;
            text-align: center;
            transition: transform 0.3s ease;
        }

        .intro-card:hover {
            transform: translateY(-5px);
        }

        .intro-icon {
            font-size: 2.5rem;
            color: var(--accent);
            margin-bottom: 1rem;
        }

        /* 房间输入样式 */
        .room-input {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
            max-width: 500px;
            margin: 0 auto;
        }

        .input-group {
            width: 100%;
        }

        .input-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .input-group input {
            width: 100%;
            padding: 0.8rem 1rem;
            border-radius: 8px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1.1rem;
            text-align: center;
        }

        /* 角色选择样式 */
        .character-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .character-card {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 1.5rem;
            transition: transform 0.3s ease;
            border-left: 4px solid var(--accent);
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .character-card:hover {
            transform: translateY(-5px);
            background-color: rgba(255, 255, 255, 0.15);
        }

        .character-name {
            font-size: 1.3rem;
            color: var(--accent);
            margin-bottom: 0.5rem;
        }

        .character-role {
            font-size: 0.9rem;
            color: var(--secondary);
            margin-bottom: 1rem;
            font-style: italic;
        }

        .character-description {
            line-height: 1.6;
            font-size: 0.95rem;
            margin-bottom: 1rem;
            flex-grow: 1;
        }

        .character-ability {
            background-color: rgba(255, 255, 255, 0.1);
            padding: 0.8rem;
            border-radius: 6px;
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .ability-placeholder {
            color: rgba(255, 255, 255, 0.7);
            font-style: italic;
        }

        /* 游戏主界面样式 */
        .game-container {
            display: grid;
            grid-template-columns: 1fr 3fr 1fr;
            gap: 1.5rem;
            height: 80vh;
        }

        .game-panel {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
        }

        .game-panel.left {
            justify-content: space-between;
        }

        .game-panel.right {
            justify-content: space-between;
        }

        .era-display {
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
            margin-bottom: 1rem;
        }

        .era-name {
            font-size: 1.3rem;
            color: var(--accent);
            margin-bottom: 0.5rem;
        }

        .era-description {
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .map-container {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 3px;
            background-color: rgba(0, 0, 0, 0.2);
            padding: 10px;
            border-radius: 8px;
            height: 100%;
            overflow: auto;
        }

        .map-cell {
            aspect-ratio: 1;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 600;
            transition: all 0.2s ease;
            position: relative;
        }

        .map-cell:hover {
            transform: scale(1.1);
            z-index: 10;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }

        .empty {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .river {
            background-color: var(--river);
        }

        .rock {
            background-color: var(--rock);
        }

        .village {
            background-color: var(--village);
        }

        .large-village {
            background-color: var(--large-village);
        }

        .ghost {
            background-color: var(--ghost);
        }

        .sanctuary {
            background-color: var(--sanctuary);
            color: var(--dark);
        }

        .forest {
            background-color: var(--forest);
        }

        .resource-input {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-top: 1rem;
        }

        .resource-row {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .resource-input input {
            flex-grow: 1;
            padding: 0.5rem;
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .resource-output {
            background-color: rgba(255, 255, 255, 0.1);
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
        }

        .game-controls {
            display: flex;
            justify-content: space-between;
            margin-top: 1rem;
        }

        /* 联机相关样式 */
        .players-list {
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .player-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            border-radius: 4px;
            background-color: rgba(255, 255, 255, 0.1);
        }

        .player-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
        }

        .player-name {
            flex-grow: 1;
        }

        .player-status {
            font-size: 0.8rem;
            color: var(--success);
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: var(--success);
        }

        .status-indicator.disconnected {
            background-color: var(--danger);
        }

        .chat-container {
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            display: flex;
            flex-direction: column;
            height: 200px;
        }

        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            margin-bottom: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .chat-message {
            padding: 0.5rem;
            border-radius: 4px;
            background-color: rgba(255, 255, 255, 0.1);
        }

        .chat-input {
            display: flex;
            gap: 0.5rem;
        }

        .chat-input input {
            flex-grow: 1;
            padding: 0.5rem;
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .game-container {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr auto;
            }
            
            .map-container {
                grid-template-columns: repeat(5, 1fr);
            }
        }

        /* 隐藏页面部分 */
        .page {
            display: none;
        }

        .page.active {
            display: block;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">文明演进模拟器</div>
                <div id="room-display" style="display: none;">
                    房间号: <span id="room-number">0000</span> | 
                    玩家: <span id="player-name">未设置</span> | 
                    <span class="connection-status">
                        <span class="status-indicator" id="connection-status"></span>
                        <span id="connection-text">连接中...</span>
                    </span>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- 主页 -->
        <section id="home-page" class="page active">
            <h1 class="game-title">文明演进模拟器 - 联机版</h1>
            
            <div class="hero">
                <div class="slideshow">
                    <div class="slide active" style="background-image: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), url('https://images.unsplash.com/photo-1544551763-46a013bb70d5?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80');">
                        <div class="slide-content">
                            <h2 class="slide-title">创造你的文明</h2>
                            <p>从石器时代到工业革命，引导你的文明走向繁荣</p>
                        </div>
                    </div>
                    <div class="slide" style="background-image: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), url('https://images.unsplash.com/photo-1533237264983-4d4b2d8a6c1e?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80');">
                        <div class="slide-content">
                            <h2 class="slide-title">探索未知世界</h2>
                            <p>发现新资源，建立贸易路线，扩张你的领土</p>
                        </div>
                    </div>
                    <div class="slide" style="background-image: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), url('https://images.unsplash.com/photo-1519681393784-d120267933ba?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80');">
                        <div class="slide-content">
                            <h2 class="slide-title">与朋友一起游戏</h2>
                            <p>实时联机，共同建设文明，争夺资源</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="section">
                <h2 class="section-title">游戏介绍</h2>
                <div class="game-intro">
                    <div class="intro-card">
                        <div class="intro-icon">
                            <i class="fas fa-globe-americas"></i>
                        </div>
                        <h3>动态地图系统</h3>
                        <p>地图会随着时间自动演变，河流改道、村庄扩张、森林蔓延，创造无限可能的世界。</p>
                    </div>
                    <div class="intro-card">
                        <div class="intro-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <h3>多人在线协作</h3>
                        <p>与朋友一起游戏，输入相同房间号即可进入同一世界，共同建设文明。</p>
                    </div>
                    <div class="intro-card">
                        <div class="intro-icon">
                            <i class="fas fa-history"></i>
                        </div>
                        <h3>历史年代演进</h3>
                        <p>体验从古代到近代的12个不同历史时期，每个时期都有独特的挑战和机遇。</p>
                    </div>
                </div>
            </div>

            <div style="text-align: center; margin: 2rem 0;">
                <button id="start-game-btn" class="btn btn-accent btn-large">
                    <i class="fas fa-play"></i> 开始游戏
                </button>
            </div>
        </section>

        <!-- 房间输入页面 -->
        <section id="room-page" class="page">
            <div class="section">
                <h2 class="section-title">加入游戏房间</h2>
                <div class="room-input">
                    <p>输入四位数字房间号，与朋友进入同一游戏世界</p>
                    <div class="input-group">
                        <label for="player-name-input">你的名字</label>
                        <input type="text" id="player-name-input" maxlength="15" placeholder="请输入你的名字">
                    </div>
                    <div class="input-group">
                        <label for="room-code">房间号码</label>
                        <input type="text" id="room-code" maxlength="4" placeholder="例如: 1234">
                    </div>
                    <button id="join-room-btn" class="btn btn-accent">
                        <i class="fas fa-door-open"></i> 进入房间
                    </button>
                    <button id="create-room-btn" class="btn">
                        <i class="fas fa-plus"></i> 创建新房间
                    </button>
                </div>
            </div>
        </section>

        <!-- 角色选择页面 -->
        <section id="character-page" class="page">
            <div class="section">
                <h2 class="section-title">选择你的角色</h2>
                <div class="players-list" id="players-list">
                    <h3>房间玩家</h3>
                    <div id="players-container">
                        <!-- 玩家列表将通过JavaScript动态生成 -->
                    </div>
                </div>
                <div class="character-container" id="character-list">
                    <!-- 角色将通过JavaScript动态生成 -->
                </div>
            </div>
        </section>

        <!-- 游戏主页面 -->
        <section id="game-page" class="page">
            <div class="game-container">
                <!-- 左侧面板 -->
                <div class="game-panel left">
                    <div>
                        <h3 class="section-title">随机数字</h3>
                        <div class="generator-container">
                            <button class="btn generator-btn" data-type="two">两位数</button>
                            <button class="btn generator-btn" data-type="three">三位数</button>
                            <button class="btn generator-btn" data-type="four">四位数</button>
                        </div>
                        <div class="result-box" id="number-result">点击生成</div>
                    </div>
                    
                    <div class="resource-input">
                        <h3 class="section-title">资源管理</h3>
                        <div class="resource-row">
                            <label>格位资源:</label>
                            <input type="text" id="resource-input" placeholder="输入数字">
                        </div>
                        <div class="resource-output">
                            <p>预计基础产出: <span id="resource-output">0</span></p>
                        </div>
                    </div>

                    <!-- 玩家列表 -->
                    <div class="players-list">
                        <h3 class="section-title">在线玩家</h3>
                        <div id="game-players-container">
                            <!-- 玩家列表将通过JavaScript动态生成 -->
                        </div>
                    </div>
                </div>

                <!-- 中间地图区域 -->
                <div class="game-panel center">
                    <div class="era-display">
                        <div class="era-name" id="era-name">景章竹年</div>
                        <div class="era-description" id="era-description">皇室以 "文治" 为核心国策，在都城设 "崇文馆"，召集天下学士整理前朝散佚典籍...</div>
                    </div>
                    <div class="map-container" id="map-grid">
                        <!-- 地图格子将通过JavaScript动态生成 -->
                    </div>
                    <div class="game-controls">
                        <button id="next-era-btn" class="btn btn-accent">
                            <i class="fas fa-forward"></i> 改变年代
                        </button>
                        <button id="next-turn-btn" class="btn">
                            <i class="fas fa-step-forward"></i> 下一回合
                        </button>
                    </div>
                </div>

                <!-- 右侧面板 -->
                <div class="game-panel right">
                    <div>
                        <h3 class="section-title">事件卡</h3>
                        <button id="draw-card-btn" class="btn">
                            <i class="fas fa-dice"></i> 抽取事件卡
                        </button>
                        <div class="card-display" id="event-card">
                            <h4 id="event-title">事件标题</h4>
                            <p id="event-description">点击抽取事件卡</p>
                            <div class="card-effect">
                                <p id="event-effect">效果: 待添加</p>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <h3 class="section-title">人物能力</h3>
                        <div class="character-ability">
                            <p id="character-ability">选择角色后显示能力</p>
                        </div>

                        <!-- 聊天区域 -->
                        <div class="chat-container">
                            <h3 class="section-title">聊天</h3>
                            <div class="chat-messages" id="chat-messages">
                                <div class="chat-message">系统: 欢迎来到文明演进模拟器！</div>
                            </div>
                            <div class="chat-input">
                                <input type="text" id="chat-input" placeholder="输入消息...">
                                <button class="btn" id="send-chat-btn">发送</button>
                            </div>
                        </div>
                        
                        <button id="exit-game-btn" class="btn btn-danger" style="margin-top: 1rem;">
                            <i class="fas fa-door-open"></i> 退出游戏
                        </button>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <script>
        // 联机模拟服务器 - 使用LocalStorage模拟服务器数据交换
        class MultiplayerServer {
            constructor() {
                this.rooms = {};
                this.players = {};
                this.messageId = 0;
                
                // 监听localStorage变化以实现"服务器推送"
                window.addEventListener('storage', (e) => {
                    if (e.key && e.key.startsWith('game_server_')) {
                        const message = JSON.parse(e.newValue);
                        this.handleMessage(message);
                    }
                });
            }
            
            // 创建房间
            createRoom(roomCode, player) {
                if (this.rooms[roomCode]) {
                    return { success: false, message: '房间已存在' };
                }
                
                this.rooms[roomCode] = {
                    code: roomCode,
                    players: [player],
                    gameState: null,
                    turn: 0,
                    era: 0
                };
                
                this.players[player.id] = { ...player, room: roomCode };
                
                this.broadcastToRoom(roomCode, {
                    type: 'room_created',
                    room: this.rooms[roomCode],
                    player: player
                });
                
                return { success: true, room: this.rooms[roomCode] };
            }
            
            // 加入房间
            joinRoom(roomCode, player) {
                if (!this.rooms[roomCode]) {
                    return { success: false, message: '房间不存在' };
                }
                
                if (this.rooms[roomCode].players.length >= 4) {
                    return { success: false, message: '房间已满' };
                }
                
                this.rooms[roomCode].players.push(player);
                this.players[player.id] = { ...player, room: roomCode };
                
                this.broadcastToRoom(roomCode, {
                    type: 'player_joined',
                    room: this.rooms[roomCode],
                    player: player
                });
                
                return { success: true, room: this.rooms[roomCode] };
            }
            
            // 离开房间
            leaveRoom(playerId) {
                const player = this.players[playerId];
                if (!player) return;
                
                const roomCode = player.room;
                if (!roomCode || !this.rooms[roomCode]) return;
                
                this.rooms[roomCode].players = this.rooms[roomCode].players.filter(p => p.id !== playerId);
                delete this.players[playerId];
                
                if (this.rooms[roomCode].players.length === 0) {
                    delete this.rooms[roomCode];
                } else {
                    this.broadcastToRoom(roomCode, {
                        type: 'player_left',
                        room: this.rooms[roomCode],
                        playerId: playerId
                    });
                }
            }
            
            // 发送消息到房间
            sendMessage(roomCode, message) {
                if (!this.rooms[roomCode]) return;
                
                this.broadcastToRoom(roomCode, {
                    type: 'chat_message',
                    message: message
                });
            }
            
            // 更新游戏状态
            updateGameState(roomCode, gameState) {
                if (!this.rooms[roomCode]) return;
                
                this.rooms[roomCode].gameState = gameState;
                this.broadcastToRoom(roomCode, {
                    type: 'game_state_updated',
                    gameState: gameState
                });
            }
            
            // 下一回合
            nextTurn(roomCode) {
                if (!this.rooms[roomCode]) return;
                
                this.rooms[roomCode].turn++;
                this.broadcastToRoom(roomCode, {
                    type: 'next_turn',
                    turn: this.rooms[roomCode].turn
                });
            }
            
            // 改变年代
            changeEra(roomCode, eraIndex) {
                if (!this.rooms[roomCode]) return;
                
                this.rooms[roomCode].era = eraIndex;
                this.broadcastToRoom(roomCode, {
                    type: 'era_changed',
                    era: eraIndex
                });
            }
            
            // 广播消息到房间
            broadcastToRoom(roomCode, message) {
                if (!this.rooms[roomCode]) return;
                
                message.id = this.messageId++;
                message.timestamp = Date.now();
                
                // 使用localStorage模拟服务器推送
                this.rooms[roomCode].players.forEach(player => {
                    localStorage.setItem(`game_client_${player.id}`, JSON.stringify(message));
                });
                
                // 也发送给自己
                if (window.gameClient && window.gameClient.player) {
                    localStorage.setItem(`game_client_${window.gameClient.player.id}`, JSON.stringify(message));
                }
            }
            
            // 处理消息
            handleMessage(message) {
                if (window.gameClient && window.gameClient.handleServerMessage) {
                    window.gameClient.handleServerMessage(message);
                }
            }
        }

        // 客户端
        class GameClient {
            constructor() {
                this.player = null;
                this.room = null;
                this.server = new MultiplayerServer();
                this.connected = false;
                
                // 定期检查服务器消息
                setInterval(() => {
                    this.checkServerMessages();
                }, 500);
            }
            
            // 连接到服务器
            connect(playerName) {
                const playerId = 'player_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                this.player = {
                    id: playerId,
                    name: playerName,
                    character: null,
                    ready: false
                };
                
                this.connected = true;
                this.updateConnectionStatus(true);
                
                return this.player;
            }
            
            // 创建房间
            createRoom(roomCode) {
                if (!this.player) return { success: false, message: '未连接' };
                
                const result = this.server.createRoom(roomCode, this.player);
                if (result.success) {
                    this.room = result.room;
                }
                
                return result;
            }
            
            // 加入房间
            joinRoom(roomCode) {
                if (!this.player) return { success: false, message: '未连接' };
                
                const result = this.server.joinRoom(roomCode, this.player);
                if (result.success) {
                    this.room = result.room;
                }
                
                return result;
            }
            
            // 离开房间
            leaveRoom() {
                if (!this.player) return;
                
                this.server.leaveRoom(this.player.id);
                this.room = null;
                this.player.character = null;
                this.player.ready = false;
            }
            
            // 发送聊天消息
            sendChatMessage(message) {
                if (!this.room) return;
                
                this.server.sendMessage(this.room.code, {
                    player: this.player.name,
                    text: message,
                    timestamp: Date.now()
                });
            }
            
            // 更新游戏状态
            updateGameState(gameState) {
                if (!this.room) return;
                
                this.server.updateGameState(this.room.code, gameState);
            }
            
            // 下一回合
            nextTurn() {
                if (!this.room) return;
                
                this.server.nextTurn(this.room.code);
            }
            
            // 改变年代
            changeEra(eraIndex) {
                if (!this.room) return;
                
                this.server.changeEra(this.room.code, eraIndex);
            }
            
            // 选择角色
            selectCharacter(character) {
                if (!this.player) return;
                
                this.player.character = character;
                this.player.ready = true;
                
                if (this.room) {
                    this.server.broadcastToRoom(this.room.code, {
                        type: 'player_ready',
                        player: this.player
                    });
                }
            }
            
            // 检查服务器消息
            checkServerMessages() {
                if (!this.player) return;
                
                const messageStr = localStorage.getItem(`game_client_${this.player.id}`);
                if (messageStr) {
                    const message = JSON.parse(messageStr);
                    this.handleServerMessage(message);
                    localStorage.removeItem(`game_client_${this.player.id}`);
                }
            }
            
            // 处理服务器消息
            handleServerMessage(message) {
                switch (message.type) {
                    case 'room_created':
                    case 'player_joined':
                    case 'player_left':
                        this.room = message.room;
                        this.updatePlayersList();
                        break;
                    case 'chat_message':
                        this.displayChatMessage(message.message);
                        break;
                    case 'game_state_updated':
                        if (window.gameMap) {
                            window.gameMap = message.gameState;
                            renderMap();
                        }
                        break;
                    case 'next_turn':
                        if (this.room) {
                            this.room.turn = message.turn;
                        }
                        break;
                    case 'era_changed':
                        if (this.room) {
                            this.room.era = message.era;
                            updateEraDisplay();
                        }
                        break;
                    case 'player_ready':
                        this.updatePlayersList();
                        break;
                }
            }
            
            // 更新玩家列表
            updatePlayersList() {
                if (!this.room) return;
                
                const playersContainer = document.getElementById('players-container') || 
                                        document.getElementById('game-players-container');
                if (!playersContainer) return;
                
                playersContainer.innerHTML = '';
                
                this.room.players.forEach(player => {
                    const playerElement = document.createElement('div');
                    playerElement.className = 'player-item';
                    
                    playerElement.innerHTML = `
                        <div class="player-avatar">${player.name.charAt(0)}</div>
                        <div class="player-name">${player.name}</div>
                        <div class="player-status">${player.ready ? '已准备' : '未准备'}</div>
                    `;
                    
                    playersContainer.appendChild(playerElement);
                });
            }
            
            // 显示聊天消息
            displayChatMessage(message) {
                const chatMessages = document.getElementById('chat-messages');
                if (!chatMessages) return;
                
                const messageElement = document.createElement('div');
                messageElement.className = 'chat-message';
                messageElement.textContent = `${message.player}: ${message.text}`;
                
                chatMessages.appendChild(messageElement);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            
            // 更新连接状态
            updateConnectionStatus(connected) {
                const statusIndicator = document.getElementById('connection-status');
                const statusText = document.getElementById('connection-text');
                
                if (statusIndicator && statusText) {
                    if (connected) {
                        statusIndicator.className = 'status-indicator';
                        statusText.textContent = '已连接';
                    } else {
                        statusIndicator.className = 'status-indicator disconnected';
                        statusText.textContent = '未连接';
                    }
                }
            }
        }

        // 初始化游戏客户端
        window.gameClient = new GameClient();

        // 页面导航
        document.getElementById('start-game-btn').addEventListener('click', function() {
            showPage('room-page');
        });

        document.getElementById('join-room-btn').addEventListener('click', function() {
            const playerName = document.getElementById('player-name-input').value.trim();
            const roomCode = document.getElementById('room-code').value;
            
            if (!playerName) {
                alert('请输入你的名字');
                return;
            }
            
            if (roomCode.length !== 4 || isNaN(roomCode)) {
                alert('请输入有效的4位数字房间号');
                return;
            }
            
            // 连接服务器
            window.gameClient.connect(playerName);
            
            // 加入房间
            const result = window.gameClient.joinRoom(roomCode);
            
            if (result.success) {
                document.getElementById('room-number').textContent = roomCode;
                document.getElementById('player-name').textContent = playerName;
                document.getElementById('room-display').style.display = 'block';
                showPage('character-page');
                generateCharacterCards();
                
                // 更新玩家列表
                window.gameClient.updatePlayersList();
            } else {
                alert(result.message);
            }
        });

        document.getElementById('create-room-btn').addEventListener('click', function() {
            const playerName = document.getElementById('player-name-input').value.trim();
            const roomCode = document.getElementById('room-code').value;
            
            if (!playerName) {
                alert('请输入你的名字');
                return;
            }
            
            if (roomCode.length !== 4 || isNaN(roomCode)) {
                alert('请输入有效的4位数字房间号');
                return;
            }
            
            // 连接服务器
            window.gameClient.connect(playerName);
            
            // 创建房间
            const result = window.gameClient.createRoom(roomCode);
            
            if (result.success) {
                document.getElementById('room-number').textContent = roomCode;
                document.getElementById('player-name').textContent = playerName;
                document.getElementById('room-display').style.display = 'block';
                showPage('character-page');
                generateCharacterCards();
                
                // 更新玩家列表
                window.gameClient.updatePlayersList();
            } else {
                alert(result.message);
            }
        });

        document.getElementById('exit-game-btn').addEventListener('click', function() {
            if (confirm('确定要退出游戏吗？')) {
                window.gameClient.leaveRoom();
                document.getElementById('room-display').style.display = 'none';
                showPage('home-page');
            }
        });

        // 聊天功能
        document.getElementById('send-chat-btn').addEventListener('click', function() {
            const chatInput = document.getElementById('chat-input');
            const message = chatInput.value.trim();
            
            if (message) {
                window.gameClient.sendChatMessage(message);
                chatInput.value = '';
            }
        });

        document.getElementById('chat-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('send-chat-btn').click();
            }
        });

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(pageId).classList.add('active');
        }

        // 幻灯片功能
        let currentSlide = 0;
        const slides = document.querySelectorAll('.slide');

        function showSlide(n) {
            slides.forEach(slide => slide.classList.remove('active'));
            slides[n].classList.add('active');
        }

        function nextSlide() {
            currentSlide = (currentSlide + 1) % slides.length;
            showSlide(currentSlide);
        }

        setInterval(nextSlide, 5000);

        // 随机数字生成器
        document.querySelectorAll('.generator-btn').forEach(button => {
            button.addEventListener('click', function() {
                const type = this.getAttribute('data-type');
                let min, max;
                
                switch(type) {
                    case 'two':
                        min = 10;
                        max = 99;
                        break;
                    case 'three':
                        min = 100;
                        max = 999;
                        break;
                    case 'four':
                        min = 1000;
                        max = 9999;
                        break;
                }
                
                const randomNum = Math.floor(Math.random() * (max - min + 1)) + min;
                document.getElementById('number-result').textContent = randomNum;
            });
        });

        // 资源计算
        document.getElementById('resource-input').addEventListener('input', function() {
            const value = parseInt(this.value) || 0;
            document.getElementById('resource-output').textContent = Math.floor(value * 1.5);
        });

        // 角色数据
        const characters = [
            {
                name: "凌川",
                role: "河流摆渡人",
                background: "世代居住在河流旁的摆渡人，祖父曾是 MAT 队的临时后勤员，1973 年协助杰克奥特曼人间体乡秀树打捞战斗后沉入河底的奥特手镯碎片。家中堂屋供奉着祖父留下的 MAT 队徽章（编号两位数 '37'），以及泛黄的古籍 —— 上面用毛笔记录着 12 种水系怪兽的习性弱点，书页边缘还沾有当年河流的泥沙。",
                ability: "河流相关操作消耗减少20%"
            },
            {
                name: "凯伦",
                role: "失忆的宇宙观测员",
                background: "三年前驾驶的小型观测舰在村庄上空失控坠毁，被村民救起后便忘记了身份。他随身携带的金属牌（刻有四位数 '7029'）其实是光之国第 702 号观测站的密钥，每当靠近鬼冢，金属牌就会发烫，耳边会响起模糊的 '观测站失联''能量异常' 等声音。",
                ability: "可以提前感知鬼冢位置"
            },
            {
                name: "莫林",
                role: "圣域守护者后裔",
                background: "家族从江户时代就负责守护圣域，她从小在圣域的石柱群中长大，每天清晨要在祭坛前诵读奥特文字祷文，十岁时就能独立解读石柱上关于 '光之封印' 的预言。腰间挂着的两位数 '18' 个能量储存吊坠，对应家族世代守护的 18 个封印节点。",
                ability: "圣域效果增强50%"
            },
            {
                name: "陆岩",
                role: "地质研究所研究员",
                background: "父亲曾是 UGM 队员，1986 年在与安培拉星人麾下怪兽战斗时失踪，只留下一块带有黑色能量残留的岩石样本。为了寻找父亲的踪迹，他专注于研究岩石区域的异常能量，五年前在城郊岩石山区发现了与父亲遗留样本能量匹配的矿石。",
                ability: "岩石区域资源产出增加30%"
            }
        ];

        // 生成角色卡片
        function generateCharacterCards() {
            const characterContainer = document.getElementById('character-list');
            characterContainer.innerHTML = '';
            
            characters.forEach(character => {
                const card = document.createElement('div');
                card.className = 'character-card';
                
                card.innerHTML = `
                    <h3 class="character-name">${character.name}</h3>
                    <p class="character-role">${character.role}</p>
                    <p class="character-description">${character.background}</p>
                    <div class="character-ability">
                        <p><strong>能力：</strong>${character.ability}</p>
                    </div>
                    <button class="btn btn-accent select-character" data-name="${character.name}">
                        <i class="fas fa-user-check"></i> 选择角色
                    </button>
                `;
                
                characterContainer.appendChild(card);
            });

            // 添加角色选择事件
            document.querySelectorAll('.select-character').forEach(button => {
                button.addEventListener('click', function() {
                    const characterName = this.getAttribute('data-name');
                    const character = characters.find(c => c.name === characterName);
                    
                    if (character && window.gameClient) {
                        window.gameClient.selectCharacter(character);
                        document.getElementById('character-ability').textContent = `已选择: ${character.name} - ${character.ability}`;
                        showPage('game-page');
                        generateMap();
                    }
                });
            });
        }

        // 年代数据
        const eras = [
            {
                name: "景章竹年",
                description: "皇室以 '文治' 为核心国策，在都城设 '崇文馆'，召集天下学士整理前朝散佚典籍，耗时十年修成《太平文鉴》。民间私塾普及，寒门子弟可通过 '荐学制' 入馆修学，打破士族对知识的垄断。但士族虽失学权，仍掌控地方盐铁之利，常以财力干预荐举，寒门与士族的隐性博弈渐成暗流；同时，江南竹乡因过度伐竹制简，出现竹林枯萎、水土流失，部分学士开始试造 '树皮纸'，却因 '简贵纸贱' 的传统观念遭保守派抵制。",
                effect: ""
            },
            {
                name: "和璧永熙",
                description: "运河贯通南北后，扬州、苏州成为工艺重镇，玉雕、青瓷、云锦三大技艺达至巅峰 —— 玉雕师能在指尖大的玉料上雕出 '百鸟朝凤'，青瓷 '雨过天青' 釉色被皇室定为御用品。朝廷设 '百工署' 规范工艺标准，民间工匠可凭技艺获 '匠籍'，免除徭役。然过度开采昆仑山玉矿，导致矿洞坍塌、矿工逃亡；同时，南方漕运因富商囤积粮食抬价，出现 '运瓷易，运粮难' 的怪象，工艺繁荣下暗藏民生危机。",
                effect: ""
            },
            {
                name: "启元烬土",
                description: "历时五年的 '藩王之乱' 平定后，新帝颁布 '休养生息令'：将前朝残铁熔铸为农具，分予无地农民；在战乱废墟上建 '安业坊'，安置流民。但旧藩王残余势力潜伏民间，暗中散布 '复旧论'，煽动部分士族抵制均田制；同时，北方草原部落趁中原虚弱，频繁袭扰边境，复苏之路暗藏战火隐患。",
                effect: ""
            },
            {
                name: "昭星授时",
                description: "朝廷在洛阳建 '观星台'，由天文官 '司星郎' 观测星象，修订《大衍历》，将二十四节气精确到时辰，指导全国农作 —— 麦收、插秧皆依历法而行，粮产较前朝提升三成。民间兴起 '观星社'，士人以观星论道为雅事，但司星郎垄断 '星象解读权'，称 '民间观星易乱天意'，严禁百姓私藏观星仪器；同时，南方因气候异常，历法指导的农时与实际气候偏差渐大，部分农户因 '守历误农' 颗粒无收，引发对历法的质疑。",
                effect: ""
            },
            {
                name: "瀚海同风",
                description: "和亲公主带中原农技（如曲辕犁、水车）入草原，草原部落则将养马术、皮革工艺传入中原 —— 长安街头出现 '胡商坊'，售卖奶酪、胡琴；草原帐篷中开始使用中原青瓷。朝廷设 '互市监' 管理边境贸易，规定 '汉胡交易无差别征税'。但中原士族仍视草原文化为 '蛮俗'，禁止子女与胡人通婚；草原部分长老也担忧 '汉化' 会丢失部落传统，暗中阻挠年轻子弟学习中原技艺，文化融合暗藏隔阂。",
                effect: ""
            }
        ];

        let currentEra = 0;

        // 年代切换功能
        document.getElementById('next-era-btn').addEventListener('click', function() {
            currentEra = (currentEra + 1) % eras.length;
            updateEraDisplay();
            
            // 同步到服务器
            if (window.gameClient) {
                window.gameClient.changeEra(currentEra);
            }
        });

        function updateEraDisplay() {
            document.getElementById('era-name').textContent = eras[currentEra].name;
            document.getElementById('era-description').textContent = eras[currentEra].description;
        }

        // 事件卡数据
        const eventCards = [
            { 
                title: "神秘商人", 
                description: "你遇到了一位神秘的旅行商人，他出售各种稀有物品，但价格不菲。",
                effect: "" 
            },
            { 
                title: "古代遗迹", 
                description: "你发现了一座被遗忘的古代遗迹，里面可能藏有珍贵的宝物和知识。",
                effect: "" 
            },
            { 
                title: "暴风雨", 
                description: "一场突如其来的暴风雨打乱了你的行程，你需要寻找避难所。",
                effect: "" 
            },
            { 
                title: "友好部落", 
                description: "你遇到了一个友好的部落，他们邀请你参加他们的庆典活动。",
                effect: "" 
            },
            { 
                title: "迷失森林", 
                description: "你在一片神秘的森林中迷路了，需要找到正确的方向。",
                effect: "" 
            }
        ];

        // 事件卡抽取功能
        document.getElementById('draw-card-btn').addEventListener('click', function() {
            const randomIndex = Math.floor(Math.random() * eventCards.length);
            const card = eventCards[randomIndex];
            
            document.getElementById('event-title').textContent = card.title;
            document.getElementById('event-description').textContent = card.description;
            document.getElementById('event-effect').textContent = card.effect ? `效果：${card.effect}` : "效果：待添加";
        });

        // 地图生成功能
        const mapTypes = ['empty', 'river', 'rock', 'village', 'ghost', 'sanctuary', 'forest'];
        const MAP_SIZE = 100; // 10x10 网格
        
        let gameMap = [];
        let villageStates = {};
        let largeVillages = new Set();
        let turnCount = 0;

        // 地形数量限制
        const TERRAIN_LIMITS = {
            total: { min: 70, max: 80 },
            river: { min: 35, max: 40 },
            village: { min: 10, max: 15 },
            ghost: { min: 5, max: 7 },
            sanctuary: { min: 4, max: 5 }
        };

        function generateMap() {
            const mapGrid = document.getElementById('map-grid');
            mapGrid.innerHTML = '';
            gameMap = [];
            villageStates = {};
            largeVillages = new Set();
            turnCount = 0;
            
            // 初始化所有格子为空
            for (let i = 0; i < MAP_SIZE; i++) {
                gameMap.push('empty');
            }
            
            // 生成指定数量的地形
            generateSpecificTerrain('river', TERRAIN_LIMITS.river.min, TERRAIN_LIMITS.river.max);
            generateSpecificTerrain('village', TERRAIN_LIMITS.village.min, TERRAIN_LIMITS.village.max);
            generateSpecificTerrain('ghost', TERRAIN_LIMITS.ghost.min, TERRAIN_LIMITS.ghost.max);
            generateSpecificTerrain('sanctuary', TERRAIN_LIMITS.sanctuary.min, TERRAIN_LIMITS.sanctuary.max);
            
            // 用树林和岩石填充剩余的空位，使总地形数量在70-80之间
            const totalTerrainCount = getTerrainCount();
            const targetTotal = Math.floor(Math.random() * (TERRAIN_LIMITS.total.max - TERRAIN_LIMITS.total.min + 1)) + TERRAIN_LIMITS.total.min;
            const remainingTerrain = targetTotal - totalTerrainCount;
            
            if (remainingTerrain > 0) {
                // 随机选择使用树林还是岩石填充
                for (let i = 0; i < remainingTerrain; i++) {
                    let index;
                    do {
                        index = Math.floor(Math.random() * MAP_SIZE);
                    } while (gameMap[index] !== 'empty');
                    
                    // 随机选择树林或岩石
                    gameMap[index] = Math.random() < 0.7 ? 'forest' : 'rock';
                }
            }
            
            // 确保村庄数量至少10个
            ensureMinimumVillages();
            
            // 渲染地图
            renderMap();
            
            // 同步到服务器
            if (window.gameClient) {
                window.gameClient.updateGameState(gameMap);
            }
        }

        function generateSpecificTerrain(type, min, max) {
            const count = Math.floor(Math.random() * (max - min + 1)) + min;
            
            for (let i = 0; i < count; i++) {
                let index;
                do {
                    index = Math.floor(Math.random() * MAP_SIZE);
                } while (gameMap[index] !== 'empty');
                
                gameMap[index] = type;
                
                // 如果是村庄，初始化状态
                if (type === 'village') {
                    villageStates[index] = {
                        type: 'village',
                        adjacentSanctuaryTurns: 0
                    };
                }
            }
        }

        function getTerrainCount() {
            let count = 0;
            for (let i = 0; i < MAP_SIZE; i++) {
                if (gameMap[i] !== 'empty') {
                    count++;
                }
            }
            return count;
        }

        function ensureMinimumVillages() {
            let villageCount = 0;
            for (let i = 0; i < MAP_SIZE; i++) {
                if (gameMap[i] === 'village') {
                    villageCount++;
                }
            }
            
            // 如果村庄少于10个，在随机空格位上生成
            if (villageCount < TERRAIN_LIMITS.village.min) {
                const needed = TERRAIN_LIMITS.village.min - villageCount;
                for (let i = 0; i < needed; i++) {
                    let index;
                    do {
                        index = Math.floor(Math.random() * MAP_SIZE);
                    } while (gameMap[index] !== 'empty');
                    
                    gameMap[index] = 'village';
                    villageStates[index] = {
                        type: 'village',
                        adjacentSanctuaryTurns: 0
                    };
                }
            }
        }

        function renderMap() {
            const mapGrid = document.getElementById('map-grid');
            mapGrid.innerHTML = '';
            
            for (let i = 0; i < MAP_SIZE; i++) {
                const cell = document.createElement('div');
                cell.className = `map-cell ${gameMap[i]}`;
                
                // 添加文字标签
                const labels = {
                    'empty': '',
                    'river': '河',
                    'rock': '岩',
                    'village': '村',
                    'large-village': '大村',
                    'ghost': '冢',
                    'sanctuary': '圣',
                    'forest': '林'
                };
                
                cell.textContent = labels[gameMap[i]];
                mapGrid.appendChild(cell);
            }
        }

        // 辅助函数：获取相邻单元格的索引
        function getNeighbors(index) {
            const neighbors = [];
            const row = Math.floor(index / 10);
            const col = index % 10;
            
            // 上
            if (row > 0) neighbors.push(index - 10);
            // 下
            if (row < 9) neighbors.push(index + 10);
            // 左
            if (col > 0) neighbors.push(index - 1);
            // 右
            if (col < 9) neighbors.push(index + 1);
            
            return neighbors;
        }

        // 更新地图的函数
        function updateMap() {
            const newMap = [...gameMap];
            let changed = false;
            
            // 规则1: 村庄与圣域相邻3回合后成为大村庄
            for (let i = 0; i < MAP_SIZE; i++) {
                if (newMap[i] === 'village' && villageStates[i]) {
                    // 检查是否与圣域相邻
                    const neighbors = getNeighbors(i);
                    let hasSanctuary = false;
                    
                    neighbors.forEach(neighborIndex => {
                        if (newMap[neighborIndex] === 'sanctuary') {
                            hasSanctuary = true;
                        }
                    });
                    
                    if (hasSanctuary) {
                        villageStates[i].adjacentSanctuaryTurns++;
                        if (villageStates[i].adjacentSanctuaryTurns >= 3) {
                            newMap[i] = 'large-village';
                            largeVillages.add(i);
                            changed = true;
                        }
                    } else {
                        villageStates[i].adjacentSanctuaryTurns = 0;
                    }
                }
            }
            
            // 规则2: 大村庄向相邻空格位扩张
            largeVillages.forEach(villageIndex => {
                const neighbors = getNeighbors(villageIndex);
                neighbors.forEach(neighborIndex => {
                    if (newMap[neighborIndex] === 'empty') {
                        newMap[neighborIndex] = 'village';
                        villageStates[neighborIndex] = {
                            type: 'village',
                            adjacentSanctuaryTurns: 0
                        };
                        changed = true;
                    }
                });
            });
            
            // 规则3: 圣域若与鬼冢相邻，50%概率圣域变鬼冢，50%概率鬼冢变圣域
            for (let i = 0; i < MAP_SIZE; i++) {
                if (newMap[i] === 'sanctuary' || newMap[i] === 'ghost') {
                    const neighbors = getNeighbors(i);
                    let hasOpposite = false;
                    
                    neighbors.forEach(neighborIndex => {
                        if ((newMap[i] === 'sanctuary' && newMap[neighborIndex] === 'ghost') ||
                            (newMap[i] === 'ghost' && newMap[neighborIndex] === 'sanctuary')) {
                            hasOpposite = true;
                        }
                    });
                    
                    if (hasOpposite) {
                        if (Math.random() < 0.5) {
                            // 圣域变鬼冢
                            if (newMap[i] === 'sanctuary') {
                                newMap[i] = 'ghost';
                                changed = true;
                            }
                        } else {
                            // 鬼冢变圣域
                            if (newMap[i] === 'ghost') {
                                newMap[i] = 'sanctuary';
                                changed = true;
                            }
                        }
                    }
                }
            }
            
            // 规则4: 鬼冢每个回合都有1%概率消失
            for (let i = 0; i < MAP_SIZE; i++) {
                if (newMap[i] === 'ghost' && Math.random() < 0.01) {
                    newMap[i] = 'empty';
                    changed = true;
                }
            }
            
            // 规则5: 每回合鬼冢都有1%概率在空格位上生成
            for (let i = 0; i < MAP_SIZE; i++) {
                if (newMap[i] === 'empty' && Math.random() < 0.01) {
                    newMap[i] = 'ghost';
                    changed = true;
                }
            }
            
            // 更新地图
            gameMap = [...newMap];
            
            // 确保特殊地形数量符合要求
            adjustSpecialTerrains();
            
            // 重新渲染地图
            renderMap();
            
            turnCount++;
            
            // 同步到服务器
            if (window.gameClient && changed) {
                window.gameClient.updateGameState(gameMap);
            }
            
            return changed;
        }

        function adjustSpecialTerrains() {
            // 统计当前特殊地形数量
            let ghostCount = gameMap.filter(type => type === 'ghost').length;
            let sanctuaryCount = gameMap.filter(type => type === 'sanctuary').length;
            
            // 调整鬼冢数量（最多7个）
            while (ghostCount > TERRAIN_LIMITS.ghost.max) {
                const ghostIndices = gameMap.map((type, index) => type === 'ghost' ? index : -1).filter(i => i !== -1);
                const randomGhostIndex = ghostIndices[Math.floor(Math.random() * ghostIndices.length)];
                gameMap[randomGhostIndex] = 'empty';
                ghostCount--;
            }
            
            // 调整圣域数量（最多5个）
            while (sanctuaryCount > TERRAIN_LIMITS.sanctuary.max) {
                const sanctuaryIndices = gameMap.map((type, index) => type === 'sanctuary' ? index : -1).filter(i => i !== -1);
                const randomSanctuaryIndex = sanctuaryIndices[Math.floor(Math.random() * sanctuaryIndices.length)];
                gameMap[randomSanctuaryIndex] = 'empty';
                sanctuaryCount--;
            }
        }

        // 下一回合功能
        document.getElementById('next-turn-btn').addEventListener('click', function() {
            updateMap();
            
            // 同步到服务器
            if (window.gameClient) {
                window.gameClient.nextTurn();
            }
        });

        // 初始化
        updateEraDisplay();
    </script>
</body>
</html>